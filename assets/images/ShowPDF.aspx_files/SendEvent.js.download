var Events = {
    _tokenId: null,
    _absolutePath: null,
    _visitId: null,
    _visitorId: null,
    getEventImage: function () {
        var eventImg = document.getElementById('eventImg');
        if (!eventImg) {
            eventImg = document.createElement('img');
            eventImg.id = 'eventImg';
            eventImg.width = 1;
            eventImg.height = 1;
            eventImg.alt = '';
            eventImg.border = 0;
            document.body.appendChild(eventImg);
        }
        return eventImg;
    },
    getIXIAAImage: function () {
        var eventImg = document.getElementById('ixiaaImg');
        if (!eventImg) {
            eventImg = document.createElement('img');
            eventImg.id = 'ixiaaImg';
            eventImg.width = 1;
            eventImg.height = 1;
            eventImg.alt = '';
            eventImg.border = 0;
            document.body.appendChild(eventImg);
        }
        return eventImg;
    },
    isCampaignToken: function( token ) {
        var campaignPattern  = /^\d+\.\d+\.\d+/;
        return campaignPattern.test(token);
    },
    track: function (tokenId) {
        Events._tokenId = tokenId;
        if (Events._tokenId) {
            var url = document.URL.toString();
            var eventImg = Events.getEventImage();
            var params = '';
            var timeStamp = new Date().getTime();
            params += 'url=' + encodeURIComponent(url);
            params += '&tokenId=' + Events._tokenId;
            params += '&timestamp=' + timeStamp.toString();
            var url = 'https://events.walletinsights.com/' + Events._tokenId + '/tracker.gif';
            if (params.length > 0) {
                url += '?' + params;
            }
            eventImg.src = url;

            if (Events.isCampaignToken(Events._tokenId)) {
                if (Events._absolutePath) {
                    var ixiaaImg = Events.getIXIAAImage();
                    var tokenArray = Events._tokenId.split(".");
                    var url = 'https://s.ixiaa.com/a.gif';
                    var source = Events._absolutePath;
                    url += "?partner=" + tokenArray[0] + "&client=" + tokenArray[1] + "&campaign=" + tokenArray[2] + '&source=' + encodeURIComponent(source);
                    if (Events._visitId) {
                        url += "&visitId=" + encodeURIComponent(Events._visitId);
                    }
                    if (Events._visitorId) {
                        url += "&visitorId=" + encodeURIComponent(Events._visitorId);
                    }
                    if (params.length > 0) {
                        url += "&" + params;
                    }
                    ixiaaImg.src = url;
                } else {
                    var ixiaaImg = Events.getIXIAAImage();
                    var tokenArray = Events._tokenId.split(".");
                    var url = 'https://s.ixiaa.com/a.gif';
                    var source = Events._domain;
                    url += "?partner=" + tokenArray[0] + "&client=" + tokenArray[1] + "&campaign=" + tokenArray[2] + '&source=' + encodeURIComponent(source);
                    if (Events._visitId) {
                        url += "&visitId=" + encodeURIComponent(Events._visitId);
                    }
                    if (Events._visitorId) {
                        url += "&visitorId=" + encodeURIComponent(Events._visitorId);
                    }
                    if (params.length > 0) {
                        url += "&" + params;
                    }
                    ixiaaImg.src = url;
                }
            }
        }
    },
    trackEvent: function (nameValuePairs) {
        if (Events._tokenId) {
            var url = document.URL.toString();
            var eventImg = Events.getEventImage();
            var timeStamp = new Date().getTime();
            var params = '';
            params += 'url=' + encodeURIComponent(url);
            params += '&tokenId=' + Events._tokenId;
            if (nameValuePairs) {
                for (var key in nameValuePairs) {
                    if (params.length > 0) {
                        params += '&';
                    }
                    params += key + '=' + nameValuePairs[key];
                }
            }
            params += '&timestamp=' + timeStamp.toString();
            var url = 'https://events.walletinsights.com/' + Events._tokenId + '/tracker.gif';
            if (params.length > 0) {
                url += '?' + params;
            }
            eventImg.src = url;
            
            if (Events.isCampaignToken(Events._tokenId)) {
                var ixiaaImg = Events.getIXIAAImage();
                var tokenArray = Events._tokenId.split(".");
                var url = 'https://s.ixiaa.com/a.gif';
                url += "?partner=" + tokenArray[0] + "&client=" + tokenArray[1] + "&campaign=" + tokenArray[2];
                if (Events._visitId) {
                    url += "&visitId=" + encodeURIComponent(Events._visitId);
                }
                if (Events._visitorId) {
                    url += "&visitorId=" + encodeURIComponent(Events._visitorId);
                }
                if (params.length > 0) {
                    url += "&" + params;
                }
                ixiaaImg.src = url;
            }
        }
    },
    sendEvent: function (type, nameValuePairs) {
        var eventImg = Events.getEventImage();
        var params = '';
        if (nameValuePairs) {
            for (var key in nameValuePairs) {
                if (params.length > 0) {
                    params += '&';
                }
                params += key + '=' + nameValuePairs[key];
            }
        }
        if (params.length > 0) {
            params += '&';
        }
        var timeStamp = new Date().getTime();
        params += 'timestamp=' + timeStamp.toString();
        var url = 'https://events.walletinsights.com/' + type + '/tracker.gif';
        if (params.length > 0) {
            url += '?' + params;
        }
        eventImg.src = url;

        if (Events.isCampaignToken(Events._tokenId)) {
            var ixiaaImg = Events.getIXIAAImage();
            var tokenArray = Events._tokenId.split(".");
            var url = 'https://s.ixiaa.com/a.gif';
            url += "?partner=" + tokenArray[0] + "&client=" + tokenArray[1] + "&campaign=" + tokenArray[2];
            if (params.length > 0) {
                url += "&" + params;
            }
            ixiaaImg.src = url;
        }
    }
};

var ixi_tokenId = '';
if (typeof _events != 'undefined') {
    for (var ii = 0; ii < _events.length; ii++) {
        try {
            var array = _events[ii];
            if (array[0].toLowerCase() == '_tokenid') {
                ixi_tokenId = array[1].toString();
                break;
            }
        } catch (ex) {
            //
        }
    }
}

if (ixi_tokenId) {
    var ixi_url = document.URL.toString();
    var ixi_allScripts = document.createElement('script');
    ixi_allScripts.type = 'text/javascript';
    ixi_allScripts.src = 'https://events.walletinsights.com/' + ixi_tokenId + '/All.js?url=' + encodeURIComponent(ixi_url);
    var ixi_s = document.getElementsByTagName('script')[0];
    ixi_s.parentNode.insertBefore(ixi_allScripts, ixi_s);
}
